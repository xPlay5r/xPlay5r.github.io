<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ê–Ω–≥–ª–∏–π—Å–∫–∏–µ —à–∞—à–∫–∏ - –∏–∑—É—á–µ–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –≥–ª–∞–≥–æ–ª–æ–≤</title>
<style>
  body {
    font-family: 'Nunito', sans-serif;
    background: linear-gradient(to right, #ffecd2, #fcb69f);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    user-select: none;
  }
  h1, h2 {
    font-weight: 700;
    color: #333;
    text-align: center;
  }
  button {
    font-family: 'Nunito', sans-serif;
    padding: 12px 20px;
    margin-top: 15px;
    font-size: 16px;
    background-color: #FF6B6B;
    color: white;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
  }
  button:hover {
    background-color: #ff8787;
    transform: scale(1.05);
  }
  #rules {
    background: white;
    border: 3px solid #444;
    padding: 15px;
    width: 400px;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    border-radius: 15px;
  }
  #rules h3 {
    margin-top: 0;
    text-align: center;
  }
  #rules button {
    margin-top: 15px;
    padding: 10px 15px;
    font-weight: bold;
    cursor: pointer;
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 10px;
    transition: background-color 0.3s;
  }
  #rules button:hover {
    background-color: #45a049;
  }
  #turn {
    margin-top: 90px;
    font-size: 24px;
    font-weight: bold;
    color: #222;
  }
  #board {
    display: grid;
    grid-template-columns: repeat(8, 60px);
    grid-template-rows: repeat(8, 60px);
    gap: 2px;
    background-color: #222;
    border: 5px solid #333;
    border-radius: 15px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    margin: 0 auto;
  }
  .cell {
    width: 60px;
    height: 60px;
    background-color: #f0d9b5;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .cell:nth-child(even) {
    background-color: #b58863;
  }
  .piece {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    box-shadow: inset 0 0 10px rgba(255,255,255,0.3), 0 2px 5px rgba(0,0,0,0.3);
    transition: transform 0.2s ease;
  }
  .red {
    background: linear-gradient(145deg, #ff4b5c, #ff6b6b);
  }
  .blue {
    background: linear-gradient(145deg, #4d96ff, #6db3f2);
  }
  .king::after {
    content: "üëë";
    font-size: 20px;
    position: absolute;
    top: 2px;
    right: 2px;
  }
  #questionBox {
    margin-top: 20px;
    padding: 20px;
    border-radius: 15px;
    background-color: white;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    max-width: 500px;
    text-align: center;
  }
  #question {
    font-family: 'Comic Sans MS', cursive;
    font-size: 18px;
    color: #222;
    margin-bottom: 10px;
  }
  #answer {
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    width: 60%;
  }
  #submitBtn {
    padding: 7px 15px;
    font-size: 16px;
    cursor: pointer;
    margin-left: 8px;
    background-color: #2196f3;
    color: white;
    border: none;
    border-radius: 8px;
    transition: background-color 0.3s;
  }
  #submitBtn:hover {
    background-color: #1976d2;
  }
  #feedback {
    margin-top: 10px;
    font-weight: bold;
    min-height: 24px;
    font-size: 18px;
  }
  #message {
    margin-top: 18px;
    font-size: 20px;
    color: #070;
    font-weight: 700;
    min-height: 30px;
  }
  #confetti-canvas {
    position: fixed;
    pointer-events: none;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
  }
</style>
</head>
<body>

<div id="rules">
  <h3>üéØ –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã</h3>
  <p>–ò–≥—Ä–æ–∫–∏ —Ö–æ–¥—è—Ç —à–∞—à–∫–∞–º–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ø–∏—à—É—Ç –≥–ª–∞–≥–æ–ª –≤ –ø—Ä–æ—à–µ–¥—à–µ–º –≤—Ä–µ–º–µ–Ω–∏.<br>
  –ß—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å —à–∞—à–∫—É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞, –Ω—É–∂–Ω–æ –¥–∞—Ç—å –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç.<br>
  –ü–æ–±–µ–∂–¥–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ –∑–∞—Ö–≤–∞—Ç–∏—Ç –≤—Å–µ —à–∞—à–∫–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –∏—Ö —Ö–æ–¥.<br><br>
  –ù–∞–∂–º–∏—Ç–µ <b>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</b> –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.</p>
  <button onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
</div>

<h2 id="turn"></h2>

<div id="board" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ —à–∞—à–µ–∫" role="grid" tabindex="0"></div>

<div id="questionBox" style="display:none;">
  <p id="question"></p>
  <input id="answer" autocomplete="off" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." />
  <button id="submitBtn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
  <div id="feedback"></div>
</div>

<div id="message"></div>

<canvas id="confetti-canvas"></canvas>

<audio id="ding" src="https://www.soundjay.com/buttons/sounds/button-10.mp3"></audio>
<audio id="buzz" src="https://www.soundjay.com/buttons/sounds/button-16.mp3"></audio>

<script>
(() => {
  // --- –î–∞–Ω–Ω—ã–µ –≥–ª–∞–≥–æ–ª–æ–≤ ---
  const verbs = {
    "–±—ã—Ç—å": "was/were",
    "–∏–º–µ—Ç—å": "had",
    "–¥–µ–ª–∞—Ç—å": "did",
    "–∏–¥—Ç–∏": "went",
    "–±—Ä–∞—Ç—å": "took",
    "–ø—Ä–∏—Ö–æ–¥–∏—Ç—å": "came",
    "–≤–∏–¥–µ—Ç—å": "saw",
    "–¥–∞–≤–∞—Ç—å": "gave",
    "–∑–Ω–∞—Ç—å": "knew",
    "–Ω–∞—Ö–æ–¥–∏—Ç—å": "found",
    "–¥—É–º–∞—Ç—å": "thought",
    "–ø–æ–∫—É–ø–∞—Ç—å": "bought",
    "–ø–∏—Å–∞—Ç—å": "wrote",
    "—á–∏—Ç–∞—Ç—å": "read",
    "–≥–æ–≤–æ—Ä–∏—Ç—å": "spoke",
    "–ø–∏—Ç—å": "drank",
    "–ø–µ—Ç—å": "sang",
    "–ø–∞–¥–∞—Ç—å": "fell",
    "–ø–ª–∞–≤–∞—Ç—å": "swam",
    "–µ–∑–¥–∏—Ç—å": "rode",
    "–µ—Å—Ç—å": "ate",
    "–±–µ–≥–∞—Ç—å": "ran",
    "—Å—Ç—Ä–æ–∏—Ç—å": "built",
    "–ª–æ–º–∞—Ç—å": "broke",
    "–Ω–∞—á–∏–Ω–∞—Ç—å": "began",
    "—Ä–∏—Å–æ–≤–∞—Ç—å": "drew",
    "—Å–ø–∞—Ç—å": "slept",
    "–¥–µ—Ä–∂–∞—Ç—å": "held",
    "—Å—Ç–æ—è—Ç—å": "stood",
    "—Å–∏–¥–µ—Ç—å": "sat",
    "–∫–ª–∞—Å—Ç—å": "put",
    "–≤—Å—Ç–∞–≤–∞—Ç—å": "rose",
    "–∑–∞–±—ã–≤–∞—Ç—å": "forgot",
    "–ø—Ä–æ—â–∞—Ç—å": "forgave",
    "—É—á–∏—Ç—å (–∫–æ–≥–æ-—Ç–æ)": "taught",
    "—É—á–∏—Ç—å—Å—è": "learnt",
    "—Ö—Ä–∞–Ω–∏—Ç—å": "kept",
    "–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å": "sent",
    "–ø–ª–∞—Ç–∏—Ç—å": "paid",
    "—Ç–µ—Ä—è—Ç—å": "lost",
    "–ª–æ–≤–∏—Ç—å": "caught",
    "—Ä–≤–∞—Ç—å": "tore",
    "–∫—É—Å–∞—Ç—å": "bit",
    "–±–æ—Ä–æ—Ç—å—Å—è": "fought",
    "–≤—Å—Ç—Ä–µ—á–∞—Ç—å": "met",
    "—Å—Ç–æ–∏—Ç—å": "cost",
    "–ø—Ä—è—Ç–∞—Ç—å": "hid"
  };

  // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã ---
  const boardSize = 8;
  const boardEl = document.getElementById('board');
  const turnEl = document.getElementById('turn');
  const questionBox = document.getElementById('questionBox');
  const questionEl = document.getElementById('question');
  const answerInput = document.getElementById('answer');
  const submitBtn = document.getElementById('submitBtn');
  const feedbackEl = document.getElementById('feedback');
  const messageEl = document.getElementById('message');
  const dingSound = document.getElementById('ding');
  const buzzSound = document.getElementById('buzz');

  let currentTeam = 'red'; // 'red' –∏–ª–∏ 'blue'
  let selectedPiece = null; // {row, col}
  let mustCapture = false; // –ù—É–∂–Ω–æ –ª–∏ –¥–µ–ª–∞—Ç—å –∑–∞—Ö–≤–∞—Ç —à–∞—à–∫–∏ (–µ—Å–ª–∏ –º–æ–∂–Ω–æ)
  let waitingForAnswer = false; // –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å
  let actionType = ''; // 'move' –∏–ª–∏ 'capture'
  let possibleMoves = []; // –ú–∞—Å—Å–∏–≤ –∫–ª–µ—Ç–æ–∫ –∫—É–¥–∞ –º–æ–∂–Ω–æ —Ö–æ–¥–∏—Ç—å
  let currentQuestion = null; // {verb, answer}

  // --- –ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ - –º–∞—Å—Å–∏–≤ 8x8 ---
  // 0 - –ø—É—Å—Ç–æ
  // {team: 'red'/'blue', king: false} - —à–∞—à–∫–∞ –∏–≥—Ä–æ–∫–∞
  let board = [];

  // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è ---
  function initBoard() {
    board = [];
    for(let r=0; r<boardSize; r++) {
      let row = [];
      for(let c=0; c<boardSize; c++) {
        // –†–∞—Å—Å—Ç–∞–≤–ª—è–µ–º —à–∞—à–∫–∏ –¥–ª—è red (–≤–Ω–∏–∑—É) –∏ blue (–≤–≤–µ—Ä—Ö—É) –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º
        if ((r < 3) && ((r+c)%2 === 1)) {
          row.push({team:'blue', king:false});
        } else if ((r > 4) && ((r+c)%2 === 1)) {
          row.push({team:'red', king:false});
        } else {
          row.push(0);
        }
      }
      board.push(row);
    }
  }

  // --- –†–∏—Å—É–µ–º –¥–æ—Å–∫—É ---
  function drawBoard() {
    boardEl.innerHTML = '';
    for(let r=0; r<boardSize; r++) {
      for(let c=0; c<boardSize; c++) {
        const cell = document.createElement('div');
        cell.classList.add('cell');
        if ((r+c) % 2 === 1) {
          cell.classList.add('dark');
          cell.dataset.dark = '1';
        } else {
          cell.classList.add('light');
          cell.dataset.dark = '0';
        }
        cell.dataset.row = r;
        cell.dataset.col = c;
        cell.setAttribute('role','gridcell');
        cell.setAttribute('tabindex','-1');
        if (selectedPiece && selectedPiece.row === r && selectedPiece.col === c) {
          cell.classList.add('selected');
        }

        // –ï—Å–ª–∏ –Ω–∞ –∫–ª–µ—Ç–∫–µ —à–∞—à–∫–∞
        const piece = board[r][c];
        if(piece && piece !== 0) {
          const pieceEl = document.createElement('div');
          pieceEl.classList.add('piece', piece.team);
          if(piece.king) pieceEl.style.border = '3px solid gold';
          cell.appendChild(pieceEl);
        }
        boardEl.appendChild(cell);
      }
    }
  }

  // --- –ü—Ä–æ–≤–µ—Ä–∫–∞: —à–∞—à–∫–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–º–∞–Ω–¥—ã ---
  function isCurrentTeamPiece(r,c) {
    const p = board[r][c];
    return p && p !== 0 && p.team === currentTeam;
  }

  // --- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤ –¥–ª—è —à–∞—à–∫–∏ ---
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ {toRow, toCol, capture: boolean, capturePos: {r,c} –∏–ª–∏ null}
  function getPossibleMoves(r,c) {
    const moves = [];
    const p = board[r][c];
    if(!p || p===0) return moves;
    const dir = p.team === 'red' ? -1 : 1; // red —Ö–æ–¥—è—Ç –≤–≤–µ—Ä—Ö (-1), blue –≤–Ω–∏–∑ (+1)
    const enemy = p.team === 'red' ? 'blue' : 'red';

    const directions = [];
    if (p.king) {
      // –∫–æ—Ä–æ–ª—å —Ö–æ–¥–∏—Ç –≤ 4 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      directions.push([-1,-1], [-1,1], [1,-1], [1,1]);
    } else {
      // –æ–±—ã—á–Ω–∞—è —à–∞—à–∫–∞ —Ç–æ–ª—å–∫–æ –≤–ø–µ—Ä–µ–¥
      directions.push([dir,-1], [dir,1]);
    }

    for(const [dr, dc] of directions) {
      let nr = r+dr;
      let nc = c+dc;
      if (nr>=0 && nr<boardSize && nc>=0 && nc<boardSize) {
        if(board[nr][nc]===0) {
          // —Å–≤–æ–±–æ–¥–Ω–∞—è –∫–ª–µ—Ç–∫–∞ - —Ö–æ–¥ –≤–æ–∑–º–æ–∂–µ–Ω
          moves.push({toRow: nr, toCol: nc, capture: false, capturePos: null});
        } else if(board[nr][nc]!==0 && board[nr][nc].team === enemy) {
          // –µ—Å—Ç—å –≤—Ä–∞–≥, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–µ—Ç–∫—É –¥–∞–ª—å—à–µ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞
          const jr = nr+dr;
          const jc = nc+dc;
          if(jr>=0 && jr<boardSize && jc>=0 && jc<boardSize && board[jr][jc]===0) {
            moves.push({toRow: jr, toCol: jc, capture: true, capturePos: {r:nr, c:nc}});
          }
        }
      }
    }
    return moves;
  }

  // --- –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —É –∫–æ–º–∞–Ω–¥—ã –≤–æ–∑–º–æ–∂–Ω—ã–µ –∑–∞—Ö–≤–∞—Ç—ã (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç) ---
  function teamHasCapture(team) {
    for(let r=0; r<boardSize; r++) {
      for(let c=0; c<boardSize; c++) {
        const p = board[r][c];
        if(p && p!==0 && p.team === team) {
          const moves = getPossibleMoves(r,c);
          if(moves.some(m => m.capture)) return true;
        }
      }
    }
    return false;
  }

  // --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã ---
  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É-–ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏–ª–∏ null
  function checkWin() {
    const redPieces = board.flat().filter(p => p && p!==0 && p.team==='red').length;
    const bluePieces = board.flat().filter(p => p && p!==0 && p.team==='blue').length;
    if(redPieces === 0) return 'blue';
    if(bluePieces === 0) return 'red';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ö–æ–¥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥—ã
    function canMove(team) {
      for(let r=0; r<boardSize; r++) {
        for(let c=0; c<boardSize; c++) {
          const p = board[r][c];
          if(p && p!==0 && p.team === team) {
            const moves = getPossibleMoves(r,c);
            if(moves.length > 0) return true;
          }
        }
      }
      return false;
    }
    if(!canMove('red')) return 'blue';
    if(!canMove('blue')) return 'red';

    return null;
  }

  // --- –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ö–æ–¥–∞ ---
  function updateTurnText() {
    turnEl.textContent = `The move of ${currentTeam === 'red' ? 'red' : 'blue'} team`;
  }

  // --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–∞ ---
  function generateQuestion() {
    const keys = Object.keys(verbs);
    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –≥–ª–∞–≥–æ–ª
    const verb = keys[Math.floor(Math.random()*keys.length)];
    return {verb: verb, answer: verbs[verb]};
  }

  // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ ---
  function showQuestion() {
    currentQuestion = generateQuestion();
    questionEl.textContent = `Write past form of the verb ${currentQuestion.verb}`;
    answerInput.value = '';
    feedbackEl.textContent = '';
    answerInput.focus();
    waitingForAnswer = true;
  }

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–ª–µ—Ç–∫–µ ---
  function onCellClick(e) {
    if (!waitingForAnswer) return; // –ú–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —à–∞—à–∫—É/–∫–ª–µ—Ç–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞
    const cell = e.currentTarget;
    const r = +cell.dataset.row;
    const c = +cell.dataset.col;
    if(selectedPiece) {
      // –í—Ç–æ—Ä–∞—è –∫–ª–∏–∫–∞ - –ø–æ–ø—ã—Ç–∫–∞ –ø–æ—Ö–æ–¥–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —à–∞—à–∫–æ–π
      // –ü—Ä–æ–≤–µ—Ä–∏–º, –≤—Ö–æ–¥–∏—Ç –ª–∏ —Ö–æ–¥ –≤ possibleMoves
      const move = possibleMoves.find(m => m.toRow === r && m.toCol === c);
      if(move) {
        // –ó–∞–¥–∞–µ–º actionType (move –∏–ª–∏ capture)
        actionType = move.capture ? 'capture' : 'move';
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–ª—å
        targetMove = move;
        showQuestion();
      } else {
        // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ —Ç—É–¥–∞ - –æ—Ç–º–µ–Ω—è–µ–º –≤—ã–±–æ—Ä
        selectedPiece = null;
        possibleMoves = [];
        drawBoard();
      }
    } else {
      // –ü–µ—Ä–≤–∞—è –∫–ª–∏–∫–∞ - –≤—ã–±—Ä–∞—Ç—å —à–∞—à–∫—É
      if(isCurrentTeamPiece(r,c)) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ö–æ–¥—ã –¥–ª—è —ç—Ç–æ–π —à–∞—à–∫–∏
        let moves = getPossibleMoves(r,c);
        // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞—Ö–≤–∞—Ç—ã —É –∫–æ–º–∞–Ω–¥—ã - —Ö–æ–¥–∏—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∑–∞—Ö–≤–∞—Ç–∞–º–∏
        if(teamHasCapture(currentTeam)) {
          moves = moves.filter(m => m.capture);
          if(moves.length === 0) {
            // –£ —ç—Ç–æ–π —à–∞—à–∫–∏ –∑–∞—Ö–≤–∞—Ç–æ–≤ –Ω–µ—Ç, –≤—ã–±–æ—Ä –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è
            return;
          }
        }
        if(moves.length > 0) {
          selectedPiece = {row: r, col: c};
          possibleMoves = moves;
          drawBoard();
          // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã
          highlightMoves();
        }
      }
    }
  }

  // --- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤ ---
  function highlightMoves() {
    const cells = boardEl.children;
    possibleMoves.forEach(m => {
      for(let i=0; i<cells.length; i++) {
        const cell = cells[i];
        if (+cell.dataset.row === m.toRow && +cell.dataset.col === m.toCol) {
          cell.style.outline = '3px solid yellowgreen';
        }
      }
    });
  }

  // --- –û—á–∏—Å—Ç–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ ---
  function clearHighlights() {
    const cells = boardEl.children;
    for(let i=0; i<cells.length; i++) {
      cells[i].style.outline = '';
    }
  }

  // --- –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ö–æ–¥–∞ –ø–æ—Å–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ ---
  function makeMove() {
    const {row: fr, col: fc} = selectedPiece;
    const {toRow: tr, toCol: tc, capture, capturePos} = targetMove;

    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —à–∞—à–∫—É
    const piece = board[fr][fc];
    board[tr][tc] = piece;
    board[fr][fc] = 0;

    // –ï—Å–ª–∏ –∑–∞—Ö–≤–∞—Ç - —É–¥–∞–ª—è–µ–º —à–∞—à–∫—É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
    if(capture && capturePos) {
      board[capturePos.r][capturePos.c] = 0;
    }

    // –ö–æ—Ä–æ–Ω–∞—Ü–∏—è (–µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏)
    if(piece.team === 'red' && tr === 0) piece.king = true;
    if(piece.team === 'blue' && tr === boardSize-1) piece.king = true;

    // –°–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
    selectedPiece = null;
    possibleMoves = [];
    clearHighlights();

    drawBoard();
  }

  // --- –°–º–µ–Ω–∞ —Ö–æ–¥–∞ ---
  function switchTurn() {
    currentTeam = currentTeam === 'red' ? 'blue' : 'red';
    updateTurnText();
  }

  // --- –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –∏–≥—Ä—ã ---
  window.startGame = function() {
    document.getElementById('rules').style.display = 'none';
    questionBox.style.display = 'block';
    messageEl.textContent = '';
    currentTeam = 'red';
    selectedPiece = null;
    possibleMoves = [];
    waitingForAnswer = false;
    actionType = '';
    targetMove = null;
    initBoard();
    drawBoard();
    updateTurnText();
    answerInput.disabled = false;
    submitBtn.disabled = false;
  }

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ ---
  submitBtn.onclick = () => {
    if(!waitingForAnswer) return;

    const userAnswer = answerInput.value.trim().toLowerCase();
    const correctAnswer = currentQuestion.answer.toLowerCase();

    if(userAnswer === correctAnswer) {
      feedbackEl.style.color = 'green';
      feedbackEl.textContent = 'Fantastic! üéâ';
      dingSound.play();
      confetti();

      // –í—ã–ø–æ–ª–Ω—è–µ–º —Ö–æ–¥ –∏–ª–∏ —Å—ä–µ–¥–µ–Ω–∏–µ
      makeMove();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É
      const winner = checkWin();
      if(winner) {
        messageEl.textContent = `The  ${winner === 'red' ? 'red' : 'blue'} team wins! üèÜ`;
        answerInput.disabled = true;
        submitBtn.disabled = true;
        waitingForAnswer = false;
        turnEl.textContent = '';
        return;
      }

      // –°–º–µ–Ω–∞ —Ö–æ–¥–∞
      switchTurn();

      // –°–±—Ä–æ—Å –æ–∂–∏–¥–∞–Ω–∏—è
      waitingForAnswer = false;
      actionType = '';
      selectedPiece = null;
      possibleMoves = [];

      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤—ã–±–æ—Ä—É —à–∞—à–∫–∏ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
      answerInput.value = '';
      feedbackEl.textContent = '';
      questionEl.textContent = 'Choose a checker and a square to move';
      answerInput.disabled = true;
      submitBtn.disabled = true;

    } else {
      feedbackEl.style.color = 'red';
      feedbackEl.textContent = 'Wrong answer! The move goes to the opponent.';
      buzzSound.play();

      // –°–º–µ–Ω–∞ —Ö–æ–¥–∞ –±–µ–∑ —Ö–æ–¥–∞ —à–∞—à–∫–æ–π
      switchTurn();
      waitingForAnswer = false;
      actionType = '';
      selectedPiece = null;
      possibleMoves = [];
      answerInput.value = '';
      answerInput.disabled = true;
      submitBtn.disabled = true;
      questionEl.textContent = 'Choose a checker and a square to move';
    }
  }

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –¥–æ—Å–∫–µ ---
  boardEl.addEventListener('click', (e) => {
    const target = e.target.closest('.cell');
    if(!target) return;
    // –ú–æ–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —à–∞—à–∫—É/–∫–ª–µ—Ç–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (waitingForAnswer = false)
    // –ò–ª–∏ –µ—Å–ª–∏ –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏ - —Ç–æ–≥–¥–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏
    if(waitingForAnswer) return;

    const r = +target.dataset.row;
    const c = +target.dataset.col;

    // –ï—Å–ª–∏ —à–∞—à–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤—ã–±—Ä–∞–Ω–∞
    if(selectedPiece) {
      // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ—Ö–æ–¥–∏—Ç—å
      let moves = possibleMoves;
      const move = moves.find(m => m.toRow === r && m.toCol === c);
      if(move) {
        targetMove = move;
        actionType = move.capture ? 'capture' : 'move';
        showQuestion();
        answerInput.disabled = false;
        submitBtn.disabled = false;
      } else {
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ —Ç—É–¥–∞
        selectedPiece = null;
        possibleMoves = [];
        clearHighlights();
        drawBoard();
      }
    } else {
      // –í—ã–±–æ—Ä —à–∞—à–∫–∏
      if(isCurrentTeamPiece(r,c)) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã —Å —É—á–µ—Ç–æ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞—Ö–≤–∞—Ç–∞
        let moves = getPossibleMoves(r,c);
        if(teamHasCapture(currentTeam)) {
          moves = moves.filter(m => m.capture);
          if(moves.length === 0) return;
        }
        if(moves.length > 0) {
          selectedPiece = {row: r, col: c};
          possibleMoves = moves;
          drawBoard();
          highlightMoves();
          questionEl.textContent = 'Choose a checker and a square to move';
          feedbackEl.textContent = '';
          answerInput.value = '';
          answerInput.disabled = true;
          submitBtn.disabled = true;
        }
      }
    }
  });

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª–µ –æ—Ç–≤–µ—Ç–∞ ---
  answerInput.addEventListener('keydown', e => {
    if(e.key === 'Enter') {
      submitBtn.click();
    }
  });

  // --- –ö–æ–Ω—Ñ–µ—Ç—Ç–∏ (–ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç) ---
  const confettiCanvas = document.getElementById('confetti-canvas');
  const ctx = confettiCanvas.getContext('2d');
  let confettiParticles = [];

  function resizeCanvas() {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  class ConfettiParticle {
    constructor() {
      this.x = Math.random() * confettiCanvas.width;
      this.y = Math.random() * confettiCanvas.height - confettiCanvas.height;
      this.size = 7 + Math.random()*7;
      this.speedY = 2 + Math.random()*3;
      this.speedX = (Math.random()-0.5)*1.5;
      this.color = `hsl(${Math.random()*360}, 100%, 60%)`;
      this.rotation = Math.random()*360;
      this.rotationSpeed = (Math.random()-0.5)*10;
    }
    update() {
      this.y += this.speedY;
      this.x += this.speedX;
      this.rotation += this.rotationSpeed;
      if(this.y > confettiCanvas.height) {
        this.y = -this.size;
        this.x = Math.random() * confettiCanvas.width;
      }
    }
    draw() {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.rotation * Math.PI / 180);
      ctx.fillStyle = this.color;
      ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
      ctx.restore();
    }
  }

  function confetti() {
    for(let i=0; i<150; i++) {
      confettiParticles.push(new ConfettiParticle());
    }
    let frames = 0;
    function animate() {
      frames++;
      ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      confettiParticles.forEach(p => {
        p.update();
        p.draw();
      });
      if(frames < 120) {
        requestAnimationFrame(animate);
      } else {
        confettiParticles = [];
        ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      }
    }
    animate();
  }

  // --- –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ---
  questionEl.textContent = 'Click "Start a game" to start';
})();
</script>

</body>
</html>
